<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FuelIQ - Your Intelligent Nutrition Companion</title>
  <link rel="preload" href="enhanced-integration-system.js" as="script">
  <link rel="preload" href="meals-tab.js" as="script">
  <link rel="preload" href="meal-planning.js" as="script">
  <link rel="preload" href="grocery-delivery.js" as="script">
  <link rel="preload" href="pantry-tab.js" as="script">
  <link rel="preload" href="weight-journey.js" as="script">
  <script src="profile-tab.js"></script>
  <link rel="preload" href="wearables-tab.js" as="script">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Firebase SDKs -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
    import { getFirestore, doc, setDoc, getDoc, collection, addDoc, updateDoc, deleteDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

    // Your Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyBCYBrSAO4Fd1sDzHzFW9Y75WRfknVqdoo",
      authDomain: "fueliq-168ef.firebaseapp.com",
      projectId: "fueliq-168ef",
      storageBucket: "fueliq-168ef.firebasestorage.app",
      messagingSenderId: "816524608091",
      appId: "1:816524608091:web:682d4afd1d1a97aa6d357e",
      measurementId: "G-PRGBWY5T28"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Make Firebase available globally
    window.firebaseAuth = auth;
    window.firebaseDB = db;
    window.firebaseUtils = {
      createUserWithEmailAndPassword,
      signInWithEmailAndPassword,
      onAuthStateChanged,
      signOut,
      doc,
      setDoc,
      getDoc,
      collection,
      addDoc,
      updateDoc,
      deleteDoc
    };

    // Enhanced Cloud Data Manager
    window.CloudDataManager = {
      // Save user profile to cloud
      async saveProfile(userId, profileData) {
        try {
          await setDoc(doc(db, 'userProfiles', userId), {
            ...profileData,
            updatedAt: new Date().toISOString()
          });
          console.log('‚úÖ Profile saved to cloud');
          return true;
        } catch (error) {
          console.error('‚ùå Error saving profile:', error);
          return false;
        }
      },

      // Load user profile from cloud
      async loadProfile(userId) {
        try {
          const docSnap = await getDoc(doc(db, 'userProfiles', userId));
          if (docSnap.exists()) {
            console.log('‚úÖ Profile loaded from cloud');
            return docSnap.data();
          }
          return null;
        } catch (error) {
          console.error('‚ùå Error loading profile:', error);
          return null;
        }
      },

      // Save meal data to cloud
      async saveMealData(userId, date, mealData) {
        try {
          await setDoc(doc(db, 'userMeals', `${userId}_${date}`), {
            ...mealData,
            userId,
            date,
            updatedAt: new Date().toISOString()
          });
          console.log('‚úÖ Meal data saved to cloud');
          return true;
        } catch (error) {
          console.error('‚ùå Error saving meal data:', error);
          return false;
        }
      },

      // Load meal data from cloud
      async loadMealData(userId, date) {
        try {
          const docSnap = await getDoc(doc(db, 'userMeals', `${userId}_${date}`));
          if (docSnap.exists()) {
            console.log('‚úÖ Meal data loaded from cloud');
            return docSnap.data();
          }
          return null;
        } catch (error) {
          console.error('‚ùå Error loading meal data:', error);
          return null;
        }
      },

      // Save analytics data to cloud
      async saveAnalyticsData(userId, analyticsData) {
        try {
          await setDoc(doc(db, 'userAnalytics', userId), {
            ...analyticsData,
            updatedAt: new Date().toISOString()
          });
          console.log('‚úÖ Analytics data saved to cloud');
          return true;
        } catch (error) {
          console.error('‚ùå Error saving analytics data:', error);
          return false;
        }
      },

      // Load analytics data from cloud
      async loadAnalyticsData(userId) {
        try {
          const docSnap = await getDoc(doc(db, 'userAnalytics', userId));
          if (docSnap.exists()) {
            console.log('‚úÖ Analytics data loaded from cloud');
            return docSnap.data();
          }
          return null;
        } catch (error) {
          console.error('‚ùå Error loading analytics data:', error);
          return null;
        }
      }
    };

    console.log('üî• Firebase initialized successfully with cloud data manager');
  </script>
  
  <style>
    .text-gradient {
      background: linear-gradient(to right, #ea580c, #dc2626);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .bg-gradient-orange-red {
      background: linear-gradient(to right, #ea580c, #dc2626, #ec4899);
    }
    .bg-gradient-card {
      background: linear-gradient(135deg, #fed7aa, #fecaca, #fbb6ce);
    }
  </style>
</head>
<body>
  <div id="root"></div>
  <script src="unified-data-manager.js"></script>
  <script src="enhanced-integration-system.js"></script>
  <script src="meals-tab.js"></script>
  <script src="pantry-tab.js"></script>
  <script src="weight-journey.js"></script>
  <script src="meal-planning.js"></script>
  <script src="grocery-delivery.js"></script>
  <script src="analytics-tab.js"></script>
  <script src="wearables-tab.js"></script>
  <script>
    const { useState, useEffect, useMemo, createContext, useContext } = React;
    const { createElement: e } = React;

    // Authentication Context
    const AuthContext = createContext();

    // Main App Wrapper with Authentication
    function FuelIQApp() {
      const [user, setUser] = useState(null);
      const [loading, setLoading] = useState(true);

      // Monitor authentication state
      useEffect(() => {
        const checkAuth = () => {
          if (window.firebaseAuth && window.firebaseUtils) {
            const unsubscribe = window.firebaseUtils.onAuthStateChanged(window.firebaseAuth, async (user) => {
              console.log('üîê Auth state changed:', user ? 'Logged in' : 'Logged out');
              
              if (user) {
                // Load user data from cloud when they log in
                try {
                  const profileData = await window.CloudDataManager.loadProfile(user.uid);
                  if (profileData) {
                    // Sync cloud data to localStorage for existing app compatibility
                    localStorage.setItem('fueliq_profile_data', JSON.stringify(profileData));
                    console.log('‚úÖ User data synced from cloud');
                  }
                } catch (error) {
                  console.warn('‚ö†Ô∏è Could not load user data from cloud:', error);
                }
              }
              
              setUser(user);
              setLoading(false);
            });
            return unsubscribe;
          } else {
            // Firebase not ready yet, try again
            setTimeout(checkAuth, 100);
          }
        };

        const unsubscribe = checkAuth();
        return () => {
          if (unsubscribe && typeof unsubscribe === 'function') {
            unsubscribe();
          }
        };
      }, []);

      if (loading) {
        return e('div', { className: 'min-h-screen bg-gradient-to-br from-orange-400 via-red-500 to-pink-600 flex items-center justify-center' },
          e('div', { className: 'text-center text-white' },
            e('div', { className: 'animate-spin rounded-full h-16 w-16 border-b-2 border-white mx-auto mb-4' }),
            e('h2', { className: 'text-2xl font-bold' }, 'üî• Loading FuelIQ...')
          )
        );
      }

      // Show login if not authenticated
      if (!user) {
        return e(LoginPage);
      }

      // Show main app if authenticated
      return e(AuthContext.Provider, { value: { user, setUser } },
        e(FuelIQMain)
      );
    }

    // Login/Signup Page Component
    function LoginPage() {
      const [isLogin, setIsLogin] = useState(true);
      const [email, setEmail] = useState('');
      const [password, setPassword] = useState('');
      const [name, setName] = useState('');
      const [loading, setLoading] = useState(false);
      const [error, setError] = useState('');

      const handleSubmit = async (e) => {
        e.preventDefault();
        setLoading(true);
        setError('');

        try {
          if (isLogin) {
            // Sign in existing user
            const userCredential = await window.firebaseUtils.signInWithEmailAndPassword(
              window.firebaseAuth, email, password
            );
            console.log('‚úÖ User signed in:', userCredential.user.email);
          } else {
            // Create new user
            const userCredential = await window.firebaseUtils.createUserWithEmailAndPassword(
              window.firebaseAuth, email, password
            );
            
            // Create user profile in Firestore
            await window.firebaseUtils.setDoc(
              window.firebaseUtils.doc(window.firebaseDB, 'users', userCredential.user.uid),
              {
                name: name,
                email: email,
                createdAt: new Date().toISOString(),
                profileComplete: false
              }
            );
            
            console.log('‚úÖ User created:', userCredential.user.email);
          }
        } catch (error) {
          console.error('‚ùå Auth error:', error);
          setError(error.message);
        }
        setLoading(false);
      };

      return e('div', { className: 'min-h-screen bg-gradient-to-br from-orange-400 via-red-500 to-pink-600 flex items-center justify-center p-4' },
        e('div', { className: 'bg-white rounded-3xl shadow-2xl p-8 w-full max-w-md' },
          // Logo/Header
          e('div', { className: 'text-center mb-8' },
            e('div', { className: 'w-16 h-16 bg-gradient-to-br from-orange-500 to-red-600 rounded-2xl flex items-center justify-center mx-auto mb-4' },
              e('span', { className: 'text-3xl text-white' }, '‚ö°')
            ),
            e('h1', { className: 'text-4xl font-bold text-gray-800 mb-2' }, 'FuelIQ'),
            e('p', { className: 'text-gray-600' }, 'Your Intelligent Nutrition Companion')
          ),

          // Login/Signup Toggle
          e('div', { className: 'flex mb-6 bg-gray-100 rounded-xl p-1' },
            e('button', {
              className: `flex-1 py-2 px-4 rounded-lg font-medium transition-all ${isLogin ? 'bg-white text-orange-600 shadow-sm' : 'text-gray-500'}`,
              onClick: () => setIsLogin(true)
            }, 'Sign In'),
            e('button', {
              className: `flex-1 py-2 px-4 rounded-lg font-medium transition-all ${!isLogin ? 'bg-white text-orange-600 shadow-sm' : 'text-gray-500'}`,
              onClick: () => setIsLogin(false)
            }, 'Sign Up')
          ),

          // Form
          e('form', { onSubmit: handleSubmit, className: 'space-y-4' },
            // Name field (signup only)
            !isLogin && e('div', {},
              e('label', { className: 'block text-sm font-medium text-gray-700 mb-1' }, 'Full Name'),
              e('input', {
                type: 'text',
                value: name,
                onChange: (e) => setName(e.target.value),
                className: 'w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-orange-500 focus:border-transparent',
                placeholder: 'Enter your full name',
                required: !isLogin
              })
            ),

            // Email field
            e('div', {},
              e('label', { className: 'block text-sm font-medium text-gray-700 mb-1' }, 'Email'),
              e('input', {
                type: 'email',
                value: email,
                onChange: (e) => setEmail(e.target.value),
                className: 'w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-orange-500 focus:border-transparent',
                placeholder: 'Enter your email',
                required: true
              })
            ),

            // Password field
            e('div', {},
              e('label', { className: 'block text-sm font-medium text-gray-700 mb-1' }, 'Password'),
              e('input', {
                type: 'password',
                value: password,
                onChange: (e) => setPassword(e.target.value),
                className: 'w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-orange-500 focus:border-transparent',
                placeholder: 'Enter your password',
                required: true,
                minLength: 6
              })
            ),

            // Error message
            error && e('div', { className: 'bg-red-50 border border-red-200 rounded-xl p-3' },
              e('p', { className: 'text-red-600 text-sm' }, error)
            ),

            // Submit button
            e('button', {
              type: 'submit',
              disabled: loading,
              className: `w-full bg-gradient-to-r from-orange-500 to-red-600 text-white py-3 px-6 rounded-xl font-semibold transition-all duration-200 ${loading ? 'opacity-50 cursor-not-allowed' : 'hover:from-orange-600 hover:to-red-700 transform hover:scale-105'}`
            }, loading ? '‚è≥ Loading...' : (isLogin ? 'üîë Sign In' : 'üöÄ Create Account'))
          ),

          // Demo info
          e('div', { className: 'mt-6 p-4 bg-blue-50 rounded-xl' },
            e('p', { className: 'text-xs text-blue-600 text-center' }, 
              'üí° Create an account to save your data across devices!'
            )
          )
        )
      );
    }

    // Enhanced Data Sync Manager
    function useDataSync() {
      const { user } = useContext(AuthContext);

      // Auto-save profile data to cloud
      const saveProfileToCloud = async (profileData) => {
        if (user && window.CloudDataManager) {
          await window.CloudDataManager.saveProfile(user.uid, profileData);
        }
      };

      // Auto-save meal data to cloud
      const saveMealDataToCloud = async (date, mealData) => {
        if (user && window.CloudDataManager) {
          await window.CloudDataManager.saveMealData(user.uid, date, mealData);
        }
      };

      // Auto-save analytics data to cloud
      const saveAnalyticsToCloud = async (analyticsData) => {
        if (user && window.CloudDataManager) {
          await window.CloudDataManager.saveAnalyticsData(user.uid, analyticsData);
        }
      };

      return {
        saveProfileToCloud,
        saveMealDataToCloud,
        saveAnalyticsToCloud
      };
    }

    // Main FuelIQ App (Your existing app with cloud sync)
    function FuelIQMain() {
      const { user } = useContext(AuthContext);
      const { saveProfileToCloud, saveMealDataToCloud, saveAnalyticsToCloud } = useDataSync();
      const [currentView, setCurrentView] = useState('profile');

      // All your existing state and functionality
      const [userProfile, setUserProfile] = useState({
        name: '',
        age: '',
        weight: '',
        height: '',
        gender: 'male',
        activityLevel: 'moderate',
        goal: 'fat_loss',
        dietaryRestrictions: [],
        allergies: [],
        healthConcerns: [],
        antiBloutPreference: false,
        foodsILove: [],
        foodsIAvoid: [],
        cuisinePreferences: []
      });
      const [goals, setGoals] = useState({});
      const [meals, setMeals] = useState([]);

      // Enhanced localStorage with cloud sync
      const enhancedLocalStorage = {
        setItem: async (key, value) => {
          // Save to localStorage for immediate access
          localStorage.setItem(key, value);
          
          // Auto-sync to cloud based on data type
          if (key === 'fueliq_profile_data') {
            await saveProfileToCloud(JSON.parse(value));
          } else if (key.startsWith('fueliq_meals_')) {
            const date = key.replace('fueliq_meals_', '');
            await saveMealDataToCloud(date, JSON.parse(value));
          } else if (key === 'fueliq_analytics_data') {
            await saveAnalyticsToCloud(JSON.parse(value));
          }
        },
        
        getItem: (key) => localStorage.getItem(key),
        removeItem: (key) => localStorage.removeItem(key)
      };

      // Make enhanced localStorage available globally
      useEffect(() => {
        window.enhancedLocalStorage = enhancedLocalStorage;
      }, []);

      // Your existing useEffect hooks and functions go here
      useEffect(() => {
        const handleNavigate = (e) => {
          console.log('üöÄ Navigation event received:', e.detail.tab);
          setCurrentView(e.detail.tab);
        };
        
        window.addEventListener('fueliq-navigate', handleNavigate);
        window.setCurrentView = setCurrentView;
        
        return () => {
          window.removeEventListener('fueliq-navigate', handleNavigate);
          window.setCurrentView = null;
        };
      }, [setCurrentView]);

      useEffect(() => {
        window.setCurrentView = setCurrentView;
        console.log('‚úÖ Navigation exposed globally');
        
        return () => {
          window.setCurrentView = null;
        };
      }, [setCurrentView]);

      // Enhanced container cleanup function
      const clearContainer = (containerId) => {
        const container = document.getElementById(containerId);
        if (container) {
          try {
            if (window.ReactDOM && window.ReactDOM.unmountComponentAtNode) {
              window.ReactDOM.unmountComponentAtNode(container);
            }
            container.innerHTML = '';
            container.style.cssText = '';
            container.className = 'meals-tab-content';
            console.log(`‚úÖ Container ${containerId} cleared successfully`);
          } catch (e) {
            console.warn(`‚ö†Ô∏è Error clearing container ${containerId}:`, e);
            container.innerHTML = '';
          }
        }
      };

      // Enhanced cleanup function
      const forceCleanup = () => {
        ['meals-container', 'journey-container', 'pantry-container', 'planning-container', 'grocery-container', 'analytics-container', 'wearables-container'].forEach(id => {
          clearContainer(id);
        });
        
        if (window.FuelIQMeals && window.FuelIQMeals.cleanup) {
          window.FuelIQMeals.cleanup();
        }
        if (window.FuelIQWeightJourney && window.FuelIQWeightJourney.cleanup) {
          window.FuelIQWeightJourney.cleanup();
        }
        if (window.FuelIQPantry && window.FuelIQPantry.cleanup) {
          window.FuelIQPantry.cleanup();
        }
        if (window.FuelIQMealPlanning && window.FuelIQMealPlanning.cleanup) {
          window.FuelIQMealPlanning.cleanup();
        }
        if (window.FuelIQGroceryDelivery && window.FuelIQGroceryDelivery.cleanup) {
          window.FuelIQGroceryDelivery.cleanup();
        }
        if (window.FuelIQAnalytics && window.FuelIQAnalytics.cleanup) {
          window.FuelIQAnalytics.cleanup();
        }
        if (window.FuelIQWearables && window.FuelIQWearables.cleanup) {
          window.FuelIQWearables.cleanup();
        }
      };

      // Calculate TDEE and macro goals
      const calculateGoals = (profile) => {
        const { age, weight, height, gender, activityLevel, goal } = profile;
        
        if (!age || !weight || !height) return {};
        
        const weightKg = weight / 2.205;
        
        let bmr;
        if (gender === 'male') {
          bmr = 10 * weightKg + 6.25 * (height * 2.54) - 5 * age + 5;
        } else {
          bmr = 10 * weightKg + 6.25 * (height * 2.54) - 5 * age - 161;
        }
        
        const activityMultipliers = {
          sedentary: 1.2,
          light: 1.375,
          moderate: 1.55,
          active: 1.725,
          very_active: 1.9
        };
        
        const tdee = bmr * activityMultipliers[activityLevel];
        
        const goalAdjustments = {
          fat_loss: -500,
          muscle_gain: 300,
          maintenance: 0,
          recomp: -200
        };
        
        const targetCalories = tdee + goalAdjustments[goal];
        
        const proteinPerKg = goal === 'muscle_gain' ? 2.2 : goal === 'fat_loss' ? 2.0 : 1.8;
        const proteinGrams = (weightKg * proteinPerKg);
        const proteinCalories = proteinGrams * 4;
        
        const fatPercentage = goal === 'fat_loss' ? 0.25 : 0.30;
        const fatCalories = targetCalories * fatPercentage;
        const fatGrams = fatCalories / 9;
        
        const carbCalories = targetCalories - proteinCalories - fatCalories;
        const carbGrams = carbCalories / 4;
        
        return {
          calories: Math.round(targetCalories),
          protein: Math.round(proteinGrams),
          carbs: Math.round(carbGrams),
          fat: Math.round(fatGrams),
          water: Math.round(weight * 0.67)
        };
      };

      // Load saved user profile when returning to setup page
      useEffect(() => {
        if (currentView === 'setup') {
          console.log('üîÑ Setup page activated - loading saved data...');
          
          try {
            if (window.UnifiedDataManager) {
              const savedProfile = window.UnifiedDataManager.getUserProfile();
              const savedGoals = window.UnifiedDataManager.getGoals();
              
              if (savedProfile) {
                console.log('‚úÖ Loaded profile from unified data manager:', savedProfile);
                setUserProfile(savedProfile);
              }
              
              if (savedGoals) {
                console.log('‚úÖ Loaded goals from unified data manager:', savedGoals);
                setGoals(savedGoals);
              }
            } else {
              const savedProfile = localStorage.getItem('fueliq_user_profile');
              if (savedProfile) {
                const parsedProfile = JSON.parse(savedProfile);
                console.log('‚úÖ Loaded profile from localStorage:', parsedProfile);
                setUserProfile(parsedProfile);
              } else {
                console.log('‚ÑπÔ∏è No saved profile found - showing empty form');
              }
            }
          } catch (e) {
            console.warn('‚ùå Error loading saved data:', e);
          }
        }
      }, [currentView]);

      // Calculate goals when user profile changes
      useEffect(() => {
        if (userProfile.age && userProfile.weight && userProfile.height) {
          setGoals(calculateGoals(userProfile));
        }
      }, [userProfile]);

      // Enhanced cleanup on view change
      useEffect(() => {
        forceCleanup();
      }, [currentView]);

      // Goals sync for meals tab
      useEffect(() => {
        if (currentView === 'meals') {
          let userGoalsData;
          
          if (window.FuelIQDataManager) {
            const goals = window.FuelIQDataManager.getGoals();
            userGoalsData = {
              dailyCalories: goals.calories,
              calories: goals.calories,
              protein: goals.protein,
              carbs: goals.carbs,
              fat: goals.fat
            };
          } else if (goals.calories) {
            userGoalsData = {
              dailyCalories: goals.calories,
              calories: goals.calories,
              protein: goals.protein,
              carbs: goals.carbs,
              fat: goals.fat
            };
          }
          
          if (userGoalsData) {
            try {
              localStorage.setItem('fueliq_user_goals', JSON.stringify(userGoalsData));
              console.log('‚úÖ Goals synchronized for meals tab:', userGoalsData);
            } catch (e) {
              console.warn('localStorage not available:', e);
            }
          }
        }
      }, [currentView, goals]);

      // All your existing useEffect hooks for tab rendering
      useEffect(() => {
        if (currentView === 'meals') {
          clearContainer('meals-container');
          
          if (window.FuelIQDataManager) {
            const goals = window.FuelIQDataManager.getGoals();
            localStorage.setItem('fueliq_user_goals', JSON.stringify(goals));
            console.log('‚úÖ Goals synchronized for meals tab');
          }
          
          let retryCount = 0;
          const maxRetries = 3;
          
          const tryRenderMeals = () => {
            if (window.FuelIQMeals && window.FuelIQMeals.renderMealsTab) {
              try {
                window.FuelIQMeals.renderMealsTab('meals-container');
                console.log('‚úÖ Meals tab rendered successfully');
              } catch (error) {
                console.error('Error rendering meals tab:', error);
              }
            } else {
              retryCount++;
              if (retryCount < maxRetries) {
                console.log(`‚è≥ Waiting for meals module... (${retryCount}/${maxRetries})`);
                setTimeout(tryRenderMeals, 1000);
              } else {
                console.warn('‚ùå Meals module failed to load');
                const container = document.getElementById('meals-container');
                if (container) {
                  container.innerHTML = `
                    <div class="max-w-6xl mx-auto p-6">
                      <div class="bg-orange-50 border border-orange-200 rounded-xl p-6">
                        <h2 class="text-xl font-bold text-orange-800 mb-2">üçΩÔ∏è Meals Tab Issue</h2>
                        <p class="text-orange-600 mb-4">Meals functionality is not loading properly.</p>
                        <button onclick="location.reload()" class="px-4 py-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600">
                          Refresh Page
                        </button>
                      </div>
                    </div>
                  `;
                }
              }
            }
          };
          
          setTimeout(tryRenderMeals, 500);
        }
      }, [currentView]);

      // Profile tab rendering
      useEffect(() => {
        if (currentView === 'profile') {
          clearContainer('profile-container');
          
          let retryCount = 0;
          const maxRetries = 10;
          
          const tryRenderProfile = () => {
            if (window.FuelIQProfile && window.FuelIQProfile.renderProfileTab) {
              try {
                window.FuelIQProfile.renderProfileTab('profile-container');
                console.log('‚úÖ Profile tab rendered successfully');
              } catch (error) {
                console.error('Error rendering profile tab:', error);
              }
            } else {
              retryCount++;
              if (retryCount < maxRetries) {
                console.log(`‚è≥ Waiting for FuelIQProfile module... (${retryCount}/${maxRetries})`);
                setTimeout(tryRenderProfile, 200);
              } else {
                console.warn('‚ùå FuelIQProfile module failed to load');
              }
            }
          };
          
          setTimeout(tryRenderProfile, 100);
        }
      }, [currentView]);

      // Pantry tab rendering
      useEffect(() => {
        if (currentView === 'pantry') {
          clearContainer('pantry-container');
          
          let retryCount = 0;
          const maxRetries = 3;
          
          const tryRenderPantry = () => {
            if (window.FuelIQPantry && window.FuelIQPantry.renderSmartPantry) {
              try {
                window.FuelIQPantry.renderSmartPantry('pantry-container');
                console.log('‚úÖ Pantry tab rendered successfully');
              } catch (error) {
                console.error('Error rendering pantry tab:', error);
              }
            } else {
              retryCount++;
              if (retryCount < maxRetries) {
                console.log(`‚è≥ Waiting for pantry module... (${retryCount}/${maxRetries})`);
                setTimeout(tryRenderPantry, 1000);
              } else {
                console.warn('‚ùå Pantry module failed to load');
                const container = document.getElementById('pantry-container');
                if (container) {
                  container.innerHTML = `
                    <div class="max-w-6xl mx-auto p-6">
                      <div class="bg-green-50 border border-green-200 rounded-xl p-6">
                        <h2 class="text-xl font-bold text-green-800 mb-2">üõí Pantry Tab Issue</h2>
                        <p class="text-green-600 mb-4">Pantry functionality is not loading properly.</p>
                        <button onclick="location.reload()" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600">
                          Refresh Page
                        </button>
                      </div>
                    </div>
                  `;
                }
              }
            }
          };
          
          setTimeout(tryRenderPantry, 500);
        }
      }, [currentView]);

      // All other tab rendering useEffects (planning, grocery, analytics, wearables)
      useEffect(() => {
        if (currentView === 'planning') {
          clearContainer('planning-container');
          
          let retryCount = 0;
          const maxRetries = 10;
          
          const tryRenderPlanning = () => {
            if (window.FuelIQMealPlanning && window.FuelIQMealPlanning.renderMealPlanning) {
              try {
                window.FuelIQMealPlanning.renderMealPlanning('planning-container');
                console.log('‚úÖ Planning tab rendered successfully');
              } catch (error) {
                console.error('Error rendering planning tab:', error);
              }
            } else {
              retryCount++;
              if (retryCount < maxRetries) {
                console.log(`‚è≥ Waiting for FuelIQMealPlanning module... (${retryCount}/${maxRetries})`);
                setTimeout(tryRenderPlanning, 200);
              } else {
                console.warn('‚ùå FuelIQMealPlanning module failed to load');
              }
            }
          };
          
          setTimeout(tryRenderPlanning, 100);
        }
      }, [currentView]);

      useEffect(() => {
        if (currentView === 'grocery') {
          clearContainer('grocery-container');
          
          let retryCount = 0;
          const maxRetries = 10;
          
          const tryRenderGrocery = () => {
            if (window.FuelIQGroceryDelivery && window.FuelIQGroceryDelivery.renderGroceryDelivery) {
              try {
                window.FuelIQGroceryDelivery.renderGroceryDelivery('grocery-container');
                console.log('‚úÖ Grocery tab rendered successfully');
              } catch (error) {
                console.error('Error rendering grocery tab:', error);
              }
            } else {
              retryCount++;
              if (retryCount < maxRetries) {
                console.log(`‚è≥ Waiting for FuelIQGroceryDelivery module... (${retryCount}/${maxRetries})`);
                setTimeout(tryRenderGrocery, 200);
              } else {
                console.warn('‚ùå FuelIQGroceryDelivery module failed to load');
              }
            }
          };
          
          setTimeout(tryRenderGrocery, 100);
        }
      }, [currentView]);

      useEffect(() => {
        if (currentView === 'analytics') {
          clearContainer('analytics-container');
          
          let retryCount = 0;
          const maxRetries = 10;
          
          const tryRenderAnalytics = () => {
            if (window.FuelIQAnalytics && window.FuelIQAnalytics.renderAnalyticsTab) {
              try {
                window.FuelIQAnalytics.renderAnalyticsTab('analytics-container');
                console.log('‚úÖ Analytics tab rendered successfully');
              } catch (error) {
                console.error('Error rendering analytics tab:', error);
              }
            } else {
              retryCount++;
              if (retryCount < maxRetries) {
                console.log(`‚è≥ Waiting for FuelIQAnalytics module... (${retryCount}/${maxRetries})`);
                setTimeout(tryRenderAnalytics, 200);
              } else {
                console.warn('‚ùå FuelIQAnalytics module failed to load');
              }
            }
          };
          
          setTimeout(tryRenderAnalytics, 100);
        }
      }, [currentView]);

      useEffect(() => {
        if (currentView === 'wearables') {
          clearContainer('wearables-container');
          
          let retryCount = 0;
          const maxRetries = 10;
          
          const tryRenderWearables = () => {
            if (window.FuelIQWearables && window.FuelIQWearables.renderWearablesHub) {
              try {
                window.FuelIQWearables.renderWearablesHub('wearables-container');
                console.log('‚úÖ Wearables tab rendered successfully');
              } catch (error) {
                console.error('Error rendering wearables tab:', error);
              }
            } else {
              retryCount++;
              if (retryCount < maxRetries) {
                console.log(`‚è≥ Waiting for FuelIQWearables module... (${retryCount}/${maxRetries})`);
                setTimeout(tryRenderWearables, 200);
              } else {
                console.warn('‚ùå FuelIQWearables module failed to load');
              }
            }
          };
          
          setTimeout(tryRenderWearables, 100);
        }
      }, [currentView]);

      // Navigation event listener
      useEffect(() => {
        const handleNavigation = (event) => {
          forceCleanup();
          setTimeout(() => {
            setCurrentView(event.detail);
          }, 100);
        };
        
        window.addEventListener('navigateToTab', handleNavigation);
        
        return () => {
          window.removeEventListener('navigateToTab', handleNavigation);
          forceCleanup();
        };
      }, []);

      // Calculate current nutrition totals
      const totals = useMemo(() => {
        const today = new Date().toISOString().split('T')[0];
        const key = `fueliq_meals_${today}`;
        try {
          const data = JSON.parse(localStorage.getItem(key) || '{}');
          const allFoods = [...(data.breakfast||[]), ...(data.lunch||[]), ...(data.dinner||[]), ...(data.snacks||[])];
          return allFoods.reduce((acc, item) => {
            const mult = (item.servingSize || 100) / 100;
            return {
              calories: acc.calories + ((item.calories || 0) * mult),
              protein: acc.protein + ((item.protein || 0) * mult),
              carbs: acc.carbs + ((item.carbs || 0) * mult),
              fat: acc.fat + ((item.fat || 0) * mult),
              fiber: acc.fiber + ((item.fiber || 0) * mult)
            };
          }, { calories: 0, protein: 0, carbs: 0, fat: 0, fiber: 0 });
        } catch (e) {
          return { calories: 0, protein: 0, carbs: 0, fat: 0, fiber: 0 };
        }
      }, [currentView]);

      // Navigation component with user info and sign out
      function Navigation() {
        const [isNavigating, setIsNavigating] = useState(false);
        
        const handleNavClick = (targetView) => {
          if (isNavigating) return;
          
          setIsNavigating(true);
          
          if (targetView === 'dashboard') {
            const profileContainer = document.getElementById('profile-container');
            if (profileContainer) {
              profileContainer.innerHTML = '';
            }
          }
          
          forceCleanup();
          
          setTimeout(() => {
            setCurrentView(targetView);
            setIsNavigating(false);
            console.log(`‚úÖ Navigated to: ${targetView}`);
          }, 100);
        };

        const handleSignOut = async () => {
          try {
            await window.firebaseUtils.signOut(window.firebaseAuth);
            console.log('‚úÖ User signed out');
          } catch (error) {
            console.error('‚ùå Sign out error:', error);
          }
        };
        
        return e('div', { className: "bg-gradient-orange-red shadow-xl" },
          e('div', { className: "max-w-7xl mx-auto px-6" },
            e('div', { className: "flex items-center justify-between py-4" },
              e('div', { className: "flex items-center space-x-4" },
                e('div', { className: "flex items-center space-x-2" },
                  e('div', { className: "w-10 h-10 bg-white rounded-xl flex items-center justify-center" },
                    e('span', { className: "text-2xl text-orange-600" }, '‚ö°')
                  ),
                  e('h1', { 
                    className: "text-2xl font-bold text-white tracking-tight", 
                    style: {fontFamily: 'Georgia, Times, serif'} 
                  }, "FuelIQ"),
                  e('span', { className: "text-orange-100 text-sm hidden md:inline" }, `Welcome, ${user?.email}!`)
                )
              ),
              
              e('div', { className: "flex items-center space-x-4" },
                // Navigation tabs
                e('div', { className: "flex space-x-1 bg-white/10 rounded-2xl p-1 overflow-x-auto backdrop-blur-sm" },
                 [
                    { id: 'profile', label: 'Profile', icon: 'üë§' },
                    { id: 'dashboard', label: 'Dashboard', icon: 'üìä', highlight: true },
                    { id: 'meals', label: 'Meals', icon: 'üçΩÔ∏è' },
                    { id: 'pantry', label: 'Pantry', icon: 'üõí' },
                    { id: 'planning', label: 'Planning', icon: 'üìÖ' },
                    { id: 'grocery', label: 'Delivery', icon: 'üöö' },
                    { id: 'wearables', label: 'Devices', icon: '‚åö' },
                    { id: 'analytics', label: 'Analytics', icon: 'üìà' },
                    { id: 'chat', label: 'AI Chat', icon: 'üí¨' }
                  ].map(({ id, label, icon }) => 
                    e('button', {
                      key: id,
                      onClick: () => handleNavClick(id),
                      disabled: isNavigating,
                      className: `flex items-center space-x-2 px-4 py-2 rounded-xl font-medium text-sm whitespace-nowrap transition-all duration-200 ${
        currentView === id
          ? (id === 'dashboard' ? 'bg-blue-500 text-white shadow-lg' : 'bg-white text-orange-600 shadow-lg')
          : 'text-white/80 hover:text-white hover:bg-white/10'
      } ${isNavigating ? 'opacity-50 cursor-not-allowed' : ''}`
                    },
                      e('span', { className: "text-lg" }, icon),
                      e('span', { className: "hidden md:inline" }, label)
                    )
                  )
                ),

                // Sign out button
                e('button', {
                  onClick: handleSignOut,
                  className: 'bg-white/20 hover:bg-white/30 px-4 py-2 rounded-lg transition-all text-white text-sm'
                }, 'üîí Sign Out')
              )
            )
          )
        );
      }

      // Special handling for profile tab
      if (currentView === 'profile') {
        return e('div', { className: "min-h-screen bg-gradient-card" },
          e(Navigation),
          e('div', { id: "profile-container", className: "profile-tab-content" })
        );
      }

      // Enhanced Dashboard view (same as your existing dashboard)
      if (currentView === 'dashboard') {
        const now = new Date();
        const today = now.toLocaleDateString('en-US', { 
          weekday: 'long', 
          year: 'numeric', 
          month: 'long', 
          day: 'numeric' 
        });
        
        const currentTime = now.toLocaleTimeString('en-US', {
          hour: 'numeric',
          minute: '2-digit',
          hour12: true
        });

        // Get goals from profile data
        const profileGoals = (() => {
          try {
            const profileData = localStorage.getItem('fueliq_profile_data');
            if (profileData) {
              const parsed = JSON.parse(profileData);
              if (parsed.goals) {
                console.log('üìä Dashboard loaded goals:', parsed.goals);
                return {
                  calories: parsed.goals.calories || 2000,
                  protein: parsed.goals.protein || 150,
                  carbs: parsed.goals.carbs || 250,
                  fat: parsed.goals.fat || 67,
                  water: parsed.goals.water || 64
                };
              }
            }
          } catch (e) {
            console.warn('Error loading goals:', e);
          }
          
          return { calories: 2000, protein: 150, carbs: 250, fat: 67, water: 64 };
        })();

        const getProgressPercentage = (current, goal) => {
          const currentNum = parseFloat(current) || 0;
          const goalNum = parseFloat(goal) || 1;
          return Math.min((currentNum / goalNum) * 100, 100);
        };

        return e('div', { className: "min-h-screen bg-gradient-card" },
          e(Navigation),
          e('div', { className: "max-w-7xl mx-auto p-6" },
            
            // Welcome Header with cloud sync indicator
            e('div', { className: "bg-gradient-to-r from-blue-600 via-purple-600 to-indigo-700 rounded-3xl shadow-2xl p-8 mb-8 text-white relative overflow-hidden" },
              e('div', { className: "absolute inset-0 opacity-10" },
                e('div', { className: "absolute top-0 left-0 w-full h-full", style: { backgroundImage: 'radial-gradient(circle at 20% 50%, white 2px, transparent 2px), radial-gradient(circle at 80% 20%, white 2px, transparent 2px)', backgroundSize: '30px 30px' } })
              ),
              
              e('div', { className: "text-center relative z-10" },
                e('div', { className: "w-20 h-20 bg-white/20 rounded-2xl flex items-center justify-center mx-auto mb-4 backdrop-blur-sm" },
                  e('span', { className: "text-4xl" }, 'üìä')
                ),
                e('h1', { 
                  className: "text-5xl font-bold mb-3", 
                  style: {fontFamily: 'Georgia, Times, serif'} 
                }, 'Dashboard'),
                e('p', { className: "text-xl opacity-90 mb-2" }, today),
                e('p', { className: "text-lg font-semibold opacity-95" }, currentTime),
                e('div', { className: "mt-4 text-sm opacity-80 flex items-center justify-center space-x-2" }, 
                  e('span', {}, 'üìà Your nutrition overview'),
                  e('span', { className: "px-2 py-1 bg-green-500 rounded-full text-xs" }, '‚òÅÔ∏è Cloud Synced')
                )
              )
            ),

            // Same main metrics grid and other dashboard content as your existing version
            // ... (all the dashboard content from your original app)
            
            // Main Metrics Grid
            e('div', { className: "grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8" },
              
              // Calories Card
              e('div', { 
                className: "bg-white/80 backdrop-blur-sm rounded-3xl shadow-2xl border border-white/20 p-6 cursor-pointer hover:scale-105 transition-all duration-200 group",
                onClick: () => setCurrentView('meals')
              },
                e('div', { className: 'flex items-center justify-between mb-4' },
                  e('div', { className: 'flex items-center space-x-3' },
                    e('div', { className: 'text-3xl p-3 bg-gradient-to-r from-orange-100 to-red-100 rounded-2xl group-hover:scale-110 transition-transform duration-200' }, 'üçΩÔ∏è'),
                    e('div', null,
                      e('h3', { className: 'text-lg font-bold text-gray-800' }, 'Calories'),
                      e('p', { className: 'text-xs text-gray-600' }, 'Daily nutrition target')
                    )
                  ),
                  e('div', { className: 'text-sm font-bold bg-gradient-to-r from-orange-500 to-red-500 bg-clip-text text-transparent' }, 
                    Math.round(getProgressPercentage(totals.calories, profileGoals.calories)) + '%'
                  )
                ),
                e('div', { className: 'mb-4' },
                  e('div', { className: 'flex items-baseline space-x-2' },
                    e('span', { className: 'text-3xl font-bold text-gray-900' }, Math.round(totals.calories || 0)),
                    e('span', { className: 'text-lg text-gray-600' }, 'kcal'),
                    e('span', { className: 'text-gray-400' }, '/'),
                    e('span', { className: 'text-lg text-gray-600' }, `${profileGoals.calories} kcal`)
                  )
                ),
                e('div', { className: 'w-full bg-gray-200 rounded-full h-3' },
                  e('div', {
                    className: 'bg-gradient-to-r from-orange-500 to-red-500 h-3 rounded-full transition-all duration-500',
                    style: { width: `${getProgressPercentage(totals.calories, profileGoals.calories)}%` }
                  })
                )
              ),
              
              // Water Card
              e('div', { 
                className: "bg-white/80 backdrop-blur-sm rounded-3xl shadow-2xl border border-white/20 p-6 cursor-pointer hover:scale-105 transition-all duration-200 group",
                onClick: () => alert('Water tracking coming soon! üö∞')
              },
                e('div', { className: 'flex items-center justify-between mb-4' },
                  e('div', { className: 'flex items-center space-x-3' },
                    e('div', { className: 'text-3xl p-3 bg-gradient-to-r from-cyan-100 to-blue-100 rounded-2xl group-hover:scale-110 transition-transform duration-200' }, 'üíß'),
                    e('div', null,
                      e('h3', { className: 'text-lg font-bold text-gray-800' }, 'Water'),
                      e('p', { className: 'text-xs text-gray-600' }, 'Stay hydrated')
                    )
                  ),
                  e('div', { className: 'text-sm font-bold text-cyan-600' }, '0%')
                ),
                e('div', { className: 'mb-4' },
                  e('div', { className: 'flex items-baseline space-x-2' },
                    e('span', { className: 'text-3xl font-bold text-gray-900' }, '0'),
                    e('span', { className: 'text-lg text-gray-600' }, 'oz'),
                    e('span', { className: 'text-gray-400' }, '/'),
                    e('span', { className: 'text-lg text-gray-600' }, `${goals.water || 64} oz`)
                  )
                ),
                e('div', { className: 'w-full bg-gray-200 rounded-full h-3' },
                  e('div', {
                    className: 'bg-gradient-to-r from-cyan-500 to-blue-500 h-3 rounded-full transition-all duration-500',
                    style: { width: '0%' }
                  })
                )
              ),
              
              // Steps Card
              e('div', { 
                className: "bg-white/80 backdrop-blur-sm rounded-3xl shadow-2xl border border-white/20 p-6 cursor-pointer hover:scale-105 transition-all duration-200 group",
                onClick: () => setCurrentView('wearables')
              },
                e('div', { className: 'flex items-center justify-between mb-4' },
                  e('div', { className: 'flex items-center space-x-3' },
                    e('div', { className: 'text-3xl p-3 bg-gradient-to-r from-green-100 to-emerald-100 rounded-2xl group-hover:scale-110 transition-transform duration-200' }, 'üëü'),
                    e('div', null,
                      e('h3', { className: 'text-lg font-bold text-gray-800' }, 'Steps'),
                      e('p', { className: 'text-xs text-gray-600' }, 'Daily activity goal')
                    )
                  ),
                  e('div', { className: 'text-sm font-bold text-green-600' }, '0%')
                ),
                e('div', { className: 'mb-4' },
                  e('div', { className: 'flex items-baseline space-x-2' },
                    e('span', { className: 'text-3xl font-bold text-gray-900' }, '0'),
                    e('span', { className: 'text-lg text-gray-600' }, ''),
                    e('span', { className: 'text-gray-400' }, '/'),
                    e('span', { className: 'text-lg text-gray-600' }, '10,000')
                  )
                ),
                e('div', { className: 'w-full bg-gray-200 rounded-full h-3' },
                  e('div', {
                    className: 'bg-gradient-to-r from-green-500 to-emerald-500 h-3 rounded-full transition-all duration-500',
                    style: { width: '0%' }
                  })
                )
              ),
              
              // Sleep Card
              e('div', { 
                className: "bg-white/80 backdrop-blur-sm rounded-3xl shadow-2xl border border-white/20 p-6 cursor-pointer hover:scale-105 transition-all duration-200 group",
                onClick: () => alert('Sleep tracking coming soon! üåô')
              },
                e('div', { className: 'flex items-center justify-between mb-4' },
                  e('div', { className: 'flex items-center space-x-3' },
                    e('div', { className: 'text-3xl p-3 bg-gradient-to-r from-purple-100 to-pink-100 rounded-2xl group-hover:scale-110 transition-transform duration-200' }, 'üò¥'),
                    e('div', null,
                      e('h3', { className: 'text-lg font-bold text-gray-800' }, 'Sleep'),
                      e('p', { className: 'text-xs text-gray-600' }, 'Rest & recovery')
                    )
                  ),
                  e('div', { className: 'text-sm font-bold text-purple-600' }, '0%')
                ),
                e('div', { className: 'mb-4' },
                  e('div', { className: 'flex items-baseline space-x-2' },
                    e('span', { className: 'text-3xl font-bold text-gray-900' }, '0h'),
                    e('span', { className: 'text-lg text-gray-600' }, ''),
                    e('span', { className: 'text-gray-400' }, '/'),
                    e('span', { className: 'text-lg text-gray-600' }, '8h')
                  )
                ),
                e('div', { className: 'w-full bg-gray-200 rounded-full h-3' },
                  e('div', {
                    className: 'bg-gradient-to-r from-purple-500 to-pink-500 h-3 rounded-full transition-all duration-500',
                    style: { width: '0%' }
                  })
                )
              )
            ),

            // Cloud sync status indicator
            e('div', { className: "bg-green-50 border border-green-200 rounded-xl p-4 mb-6" },
              e('div', { className: "flex items-center justify-between" },
                e('div', { className: "flex items-center space-x-3" },
                  e('span', { className: "text-2xl" }, '‚òÅÔ∏è'),
                  e('div', {},
                    e('h3', { className: "font-bold text-green-800" }, 'Cloud Sync Active'),
                    e('p', { className: "text-sm text-green-600" }, 'Your data is automatically backed up and synced across devices')
                  )
                ),
                e('div', { className: "text-green-600 text-sm font-medium" }, 
                  `Logged in as: ${user?.email}`
                )
              )
            )
          )
        );
      }

      // All other view handlers (same as your existing app)
      if (currentView === 'meals') {
        return e('div', { className: "min-h-screen bg-gradient-card" },
          e(Navigation),
          e('div', { id: "meals-container", className: "meals-tab-content" })
        );
      }

      if (currentView === 'pantry') {
        return e('div', { className: "min-h-screen bg-gradient-card" },
          e(Navigation),
          e('div', { id: "pantry-container", className: "pantry-tab-content" })
        );
      }

      if (currentView === 'planning') {
        return e('div', { className: "min-h-screen bg-gradient-card" },
          e(Navigation),
          e('div', { id: "planning-container", className: "planning-tab-content" })
        );
      }

      if (currentView === 'grocery') {
        return e('div', { className: "min-h-screen bg-gradient-card" },
          e(Navigation),
          e('div', { id: "grocery-container", className: "grocery-tab-content" })
        );
      }

      if (currentView === 'analytics') {
        return e('div', { className: "min-h-screen bg-gradient-card" },
          e(Navigation),
          e('div', { id: "analytics-container", className: "analytics-tab-content" })
        );
      }

      if (currentView === 'wearables') {
        return e('div', { className: "min-h-screen bg-gradient-card" },
          e(Navigation),
          e('div', { id: "wearables-container", className: "wearables-tab-content" })
        );
      }

      // Default view for other sections
      return e('div', { className: "min-h-screen bg-gradient-card" },
        e(Navigation),
        e('div', { className: "max-w-6xl mx-auto p-6" },
          e('div', { className: "bg-white/80 backdrop-blur-sm rounded-3xl shadow-2xl p-8 border border-white/20 text-center" },
            e('div', { className: "w-20 h-20 bg-gradient-to-br from-orange-500 to-red-600 rounded-2xl flex items-center justify-center mx-auto mb-6" },
              e('span', { className: "text-4xl text-white" }, '‚öôÔ∏è')
            ),
            e('h2', { className: "text-3xl font-bold mb-4 text-gradient" },
              {
                'profile': 'Profile',
                'meals': 'Food Logging',
                'pantry': 'Smart Pantry',
                'planning': 'Meal Planning',
                'grocery': 'Grocery Delivery',
                'wearables': 'Wearable Devices',
                'analytics': 'Analytics & Reports',
                'chat': 'AI Assistant'
              }[currentView] || 'Feature Coming Soon'
            ),
            e('p', { className: "text-xl text-gray-600 mb-8" }, "This section is coming soon with enhanced features!"),
            e('button', {
              onClick: () => setCurrentView('dashboard'),
              className: "px-8 py-4 bg-gradient-to-r from-orange-500 to-red-600 text-white rounded-2xl hover:from-orange-600 hover:to-red-700 font-bold text-lg shadow-xl transform hover:scale-105 transition-all duration-200"
            }, "Back to Dashboard")
          )
        )
      );
    }

    // Render the complete app with authentication
    ReactDOM.render(e(FuelIQApp), document.getElementById('root'));
  </script>
</body>
</html>
